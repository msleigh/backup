#!/usr/bin/env bash

set -eu
set -o pipefail
#set -x

# Setup

source config.bash
source functions.bash

main () {

    # Get arguments

    if [[ "$#" -ne 2 ]] ; then
        usage
        err "Incorrect number of arguments" 2
    fi

    TARGET="$1"
    DESTIN="$2"
    readonly DESTIN
    readonly TARGET

    # Dry run to flush out errors

    # NB
    # - Explicit path to local brew-installed rsync, as calling this from cron - otherwise -s not available
    # - Use of -s to protect spaces in $TARGET and $DESTIN (although seemed OK without this)
    # - Use of --rsync-path to ensure brew-installed version of rsync on remote side, otherwise -s not available
    "${RSYNC_PATH}" -avzs --delete --rsync-path="${RSYNC_PATH}" --dry-run "${TARGET}" "${DESTIN}" || err "Failed on dry run" 3

    # Backup

    date
    "${RSYNC_PATH}" -avzs --delete --rsync-path="${RSYNC_PATH}" --itemize-changes --no-perms "${TARGET}" "${DESTIN}"

}

main "$@"

exit 0
